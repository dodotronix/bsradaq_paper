\input{header.tex}

\begin{document}

\title{LHC abort gap monitor electronics upgrade}

\author{D. Belohrad, S. Mazzoni, M. Martin Nieto, P. Pacner\thanks{petr.pacner@cern.ch}, S. B. Pedersen,\\
CERN, Geneva, Switzerland}
	
\maketitle

\begin{abstract}
    The LHC Abort Gap Monitor (AGM) is part of the LHC machine protection
    system (MPS) and is designed to measure the particle population in a \SI{3}{\micro\second}
    wide region known as the "abort gap". This region needs to be kept empty to
    ensure safe beam dumps. The AGM captures the synchrotron light generated in
    the visible part of the spectrum and converts it into an electric signal.
    This signal is then processed by an acquisition system and can trigger the
    ‘abort gap cleaning’ process. The current AGM, which has been in operation
    since 2010, uses an analogue integrator ASIC and a 40 MHz
    analogue-to-digital (ADC) converter to provide the particle population
    information. However, this solution is now considered obsolete and is being
    replaced by a digital signal processing approach. Working directly in the
    digital domain not only offers more scalability but also better determinism
    and reliability. This work presents the new technical solution for the
    acquisition chain, compares the characteristics of both implementations,
    and showcases recent measurements conducted on the LHC ion and proton
    beams.
\end{abstract}

\section{Introduction}
During the flat-top phase, the LHC ring stores up to \SI{350}{MJ} of beam energy, spread across 2808 bunches with an average beam transverse size under \SI{1}{mm}.
%
This high energy density can melt metallic surfaces and quench
superconducting magnets, posing a risk to the machine~\cite{LHC_report}.
%
To safely extract the beam from the circulating beam lines, a series of kicker magnets belonging to the beam dump system is used. 
%
Kicker magnets need \SI{3}{\micro\second} to ramp up their magnetic field~\cite{beam_dump_system}.
%
This defines the size of an abort gap (AG) in the bunch train.
%
Due to system imperfections, a residual amount of particles populates this gap.
%
The typical AG population levels are two to three orders of magnitude lower in comparison to a single pilot LHC bunch.
%
When the beam dump is initiated, the particles in AG do not receive full
extraction force.
%
That causes the particles in the AG to deflect towards the vacuum chamber, possibly causing the magnets to quench. 
%
Thus, a~continuous monitoring of the AG population is necessary, which is the purpose of the AGM \cite{particles_in_ag}.
\\
This paper discusses the upgrade of the current AGM system installed in the LHC since 2010, focusing on system architecture, analog electronics chain, temperature dependence, timing instabilities, and compares both systems.

\section{System architecture}
The system architecture is shown in Fig.~\ref{fig:bsra_chain}.
%
It depicts the layout of the LHC, with beam 1 represented in blue and beam 2 in red.
%
The AGM consists of three main parts:
%
\begin{enumerate}
    \item \textbf{an optical front-end (OF)}, which includes~a pre-amplifier, located beneath the vacuum chamber,
    \item \textbf{a data acquisition system (DAQ)} deployed on an FPGA platform located outside the radiation area
    \item \textbf{a control software (SW)} that retrieves, interprets, and publishes the measured data,
\end{enumerate}
%
\begin{figure}[!tbh]
    \centering
    \includegraphics[width=\columnwidth]{bsra_chain.pdf}
    \caption{Overview of the BSRA system.}
    \label{fig:bsra_chain}
\end{figure} 

%
and is installed at LHC IP4 together with other beam diagnostic, and the LHC low-level RF system.
%
The LHC timing distribution (TTC) broadcasts through an optical cable - along the LHC - turn and bunch marks, together with other information, as e.g., actual beam energy.~\cite{ttc_distribution}.
%
The bunch and turn marks identify the start of each individual bunch, and the position of the first bunch in a turn.   
%
The AGM uses this information to re-synchronize its acquisition window to the AG.
%
\subsection{Working principle}
%
The particle population in the AG is measured intercepting the synchrotron radiation (SR). 
%
The AGM uses a Multi-channel photo-multiplier (PMT) to convert the SR light, into an electric signal.
%
Additional Neutral Density filters in the optical front-end (OF) allow  changing the light intensity intercepted by the PMT, thus optimize the system dynamic range.
% 
Subsequently, the electric signal is amplified, and transmitted over a \SI{100}{m}-long cable to a Data Acquisition (DAQ) system.
%
The DAQ integrates the incoming signal in \SI{100}{\nano\second} intervals within a \SI{6.4}{\micro\second}-long acquisition window.
%
Each of the sixty-four \SI{100}{\nano\second} integrals is independently averaged in an Exponential Moving Averager (EMA).
%
The averaged result is published to the software with a repetition rate of 10~Hz, which is sufficient to react to even the fastest changes in AG population.~\cite{high_sensitivity_measurement}.
%
\\
The measurement period is determined by the PMT used.
%
In our case, it is HAMAMATSU R5916U-50. 
%
Its maximum duty cycle is \SI{1}{\%}. 
%
With a gate pulse duration of \SI{3}{\micro\second} and one LHC revolution period of \SI{89}{\micro\second}, the measurements are taken every $4^{\text{th}}$ clock cycle (\SI{356}{\micro\second}).
%
This corresponds to a duty cycle of \SI{0.84}{\%}.
\\
%

\subsection{Current system, used since 2010}
\begin{figure}[!tbh]
    \centering
    \includegraphics[width=\columnwidth]{existing_system_processing.pdf}
    \caption{Current system block diagram}
    \label{fig:current_system_processing}
\end{figure}

The currently used system is shown in Fig.~\ref{fig:current_system_processing}.
%
The optical path, including filters, is common to both the actual version of the system, and the proposed upgrade. As well, the PMT type is the same in both systems.

The actual setup uses a digital acquisition board (DAB64x) equipped by Altera Stratix EP1S40 FPGA, used for the data processing.
%
The DAB64x hosts two Individual Bunch Measurement Systems (IBMS)~\cite{ibms}, integrating the analogue input signal via the LHCb2002 ASIC~\cite{lhcb_asic}.
%
The analogue signal is provided by MCP PMT, and it is amplified before the integration to improve on the measurement SNR.
%
The amplifier used is HAMAMATSU C5594~\cite{bsra_first_operation}, featuring a static voltage gain of \SI{36}{dBV}, in the bandwidth of \SI{50}{kHz} to \SI{1.5}{GHz}.
%
The LHCb2002 in the IBMS integrates the input amplified signal in \SI{25}{\nano\second} intervals, producing a stream of analogue 'DC-like' values.
%
These are subsequently sampled by a 40MSPS 14-bit ADC, resulting in a digital data stream, where each value corresponds to an integral of an individual LHC bunch.
%
The DAQ gateware sums four consecutive samples to compute the
bunch charge present on a~\SI{100}{ns} interval.
%
This process generates 64 values per single turn acquisition.
%
For each individual value, a standard deviation and mean value is calculated, and separately filtered by EMA. 
%
All collected data are stored in a dual-port RAM block shared to a front-end computer (FEC) via VME64 bridge.
%
The front-end acts as a server, publishing the data upstream through FESA~\cite{fesa}.

\subsection{Reasons for Upgrade}
The present AGM uses old technology to measure the beam charge. 
%
The analogue integrators used in IBMS are manufactured using obsoleted technology, rendering them impossible to get.
%
In addition, each integrator is unique: different gain, different switching characteristics, different offsets. 
%
So, the gateware must correct these effects.
%
Further, the amplifier bandwidth (50 kHz-1,5 GHz) increases system complexity, as a correction for the missing DC component needs to be implemented.
%
The amplifier gain is also fixed, so the ADC cannot optimally re-use available dynamic range.
\\
The system relies on an outdated FPGA platform, and the development SW is no more compatible with the latest operating systems. 

\section{System Upgrade}
To address the long-term maintenance concerns, the original system described above has to be completely refurbished. 
%
An updated version of the AGM was installed \textit{in parallel to the actually running AGM}, so that we can compare behavior of both systems.
%
While the optics of the new system was copied from the old one, the DAQ and the front-end amplifier were replaced by a modern solution.
%
A new DC-coupled amplifier was designed, allowing for dynamic change of the gain.
%
Original analogue integrators were replaced by a 4-channel 500MSPS 14-bit FMC-form factor sampler.
%
FMC ADC module is installed into an in-house built FPGA carrier (VFC-HD), featuring 2$\times 8$GBits DDR3 memories and a large Arria V FPGA.
%
Such solution eliminates completely the need for analogue integrators, as all the signal processing can be implemented in the gateware.  

\subsection{New DC-coupled amplifier}

Figure \ref{fig:amp_schematics} illustrates the block diagram of the new amplifier.
%
The amplifier was designed to match the used PMT, while being highly configurable.
% A = U^2/(i^2 * R^2) => A_dB = 20*log10(U/(i*R))
%
A~UART interface allows for setting a transimpedance gain.
%
The gain is selectable in a range of \SI{5.8}{mV/\micro A} to \SI{1.1}{V/\micro A}.
%
This corresponds to a~voltage gain of \SI{41}{dB} to \SI{87}{dB} in a $50\Omega$ system.
%
A programmatic DC-offset compensation is implemented in the amplifier.
%
It can be used - together with variable gain - to optimize the signal's amplitude for the ADC.
%
The amplifier implements an alarm, which interlocks the PMT gate when the incident light generates a current, that is near the PMT's maximum allowable average current.
%
The alarm threshold setting is stored through UART into the amplifier's non-volatile memory, so that it protects the PMT immediately at the amplifier power-up.
%
The alarm status is also transmitted to the gateware.
%
\begin{figure}[!tbh]
    \centering
    \includegraphics[width=\columnwidth]{amp_schematics.pdf}
    \caption{New AGM custom amplifier.}
    \label{fig:amp_schematics}
\end{figure}
%
\subsection{Acquisition system}
\begin{figure}[!tbh]
    \centering
    \includegraphics[width=\columnwidth]{bsra_daq.pdf}
    \caption{Acquisition system schematics.}
    \label{fig:bsra_daq}
\end{figure}
%
The new DAQ (Fig.~\ref{fig:bsra_daq}) receives asynchronous data samples as a stream of four frames every~\SI{8}{\nano s}, each corresponding to one channel.
%
Each frame contains 4$\times$16-bit words, storing left-aligned 14-bit ADC samples. 
%
To compute integrals over 4$\times$~\SI{25}{\nano\second} bunch slots, the system employs data tagging. 
%
The tagger resamples LHC timing, and generates timing masks, allowing for identification of bunch and turn starts within each individual ADC frame.
%
Tags are written into 2 LSBs of each word to indicate the position of the start of the bunch or turn.
\\
The start of the capture is synchronized through data tags to the AG.
%
The captured data are stored into a~FIFO, and integrated. 
%
The integrator begins summing values upon encountering the start of the bunch tag.
%
In parallel, it reads a stream of 64~values of a stored 'offset' from a pedestal memory (P[63:0]).
%
The offset is on-fly subtracted from the integrated data stream. 
%
Such pedestal subtraction is needed to remove measurement artifacts caused by the PMT gate opening and closing. 
%
The output values are filtered by an EMA, results are kept in dual-port RAM, and read out through the VME64x bus~\cite{my_thesis}.

\begin{figure}[!tbh]
    \centering
    \includegraphics[width=0.72\columnwidth]{installation.jpg}
    \caption{New AGM installed in the LHC IP4, next to BSRT.}
    \label{fig:installation}
\end{figure}

\subsection{Installation in the LHC}

The AGM~OF and DAQ are located in the LHC IP4, near the LHC RF system. The
new installation is depicted \textit{in retracted position} in Fig.~\ref{fig:installation}, highlighted by a~violet frame. Adjacent to its right is the currently utilized AGM, while
the longitudinal density monitor (LDM) occupies the left side. All instruments share the same light source
provided by the LHC beam synchronous light telescope (BSRT). The red
arrow indicates the direction of the light entering the entire table.
The light is split using multiple reflective foils into their respective destinations. Both AGM systems are equipped with LEDs installed atop of their reflective foils. These serve to perform functional tests.
The
AGM amplifier is mounted on the top of the optical front-end. This allows for easy access during interventions. The position of the installed Neutral Density Filters is pneumatically controlled.

\section{First acquired plots}
The initial measurements were conducted in November 2023 using the ion beam.
The optical system divides the SL in a~1:8 ratio, resulting in significantly
less light reaching the new system compared to the current one. Consequently,
we anticipate lower deviation values for the system measuring light with higher
intensity.
\begin{figure}[!htb]
    \begin{center}
        \scalebox{0.54}{\input{plots/ions.pgf}}
        \caption{Features comparison of the present and the upgraded AGMs.}
        \label{fig:comparison_chart}
    \end{center}
\end{figure}
Figure~\ref{fig:comparison_chart} displays the initial acquisition results of the new system compared to the current one. The red line represents
measurements by the current system, while the blue line describes the new
acquisition. Within the range of the $47^{\text{th}}$ to $63^{\text{rd}}$ bin, the gate is closed,
resulting in a~white noise. However, the red distribution gradually decays and extends
below zero due to artifacts stemming from analog integrators,
exhibiting a~non-linear behavior. The new system effectively eliminates this
artifact. The yellow distribution illustrates the value deviation of the new
acquisition from the current system, with the relative value deviation depicted
as well. In this measurement, the maximum deviation reaches~4\% in the region
corresponding to the decay of the red distribution. Additionally, a~deviation of~2\% in
the steep sections may be attributed to sample phase misalignment between the two systems.

\section{Summary}
The new AGM has been integrated onto the CERN BI standard platform VFC-HD
carrier, streamlining maintenance procedures. By eliminating IBMS cards
featuring the lhcb2002b ASIC, the design has addressed issues related to
cumbersome calibration and artifacts in the output plots. \\
The system is installed at LHC IP4, alongside the current AGM, collecting
data for further analysis. To conduct a comprehensive reliability test and
verify proper functionality, additional data collection is required. Initial
observations indicate that despite receiving less light, the new system can
still achieve comparable performance to the current AGM.

\input{bibliography}

\end{document}

