\input{header.tex}

\begin{document}

\title{LHC abort gap monitor electronics upgrade}

\author{D. Belohrad, S. Mazzoni, M. Martin Nieto, P. Pacner\thanks{petr.pacner@cern.ch}, S. B. Pedersen,\\
CERN, Geneva, Switzerland}
	
\maketitle

\begin{abstract}
    The LHC Abort Gap Monitor (AGM) is part of the LHC machine protection
    system (MPS) and is designed to measure the particle population in a \SI{3}{\micro\second}
    wide region known as the "abort gap". This region needs to be kept empty to
    ensure safe beam dumps. The AGM captures the synchrotron light generated in
    the visible part of the spectrum and converts it into an electric signal.
    This signal is then processed by an acquisition system and can trigger the
    ‘abort gap cleaning’ process. The current AGM, which has been in operation
    since 2010, uses an analogue integrator ASIC and a 40 MHz
    analogue-to-digital (ADC) converter to provide the particle population
    information. However, this solution is now considered obsolete and is being
    replaced by a digital signal processing approach. Working directly in the
    digital domain not only offers more scalability but also better determinism
    and reliability. This work presents the new technical solution for the
    acquisition chain, compares the characteristics of both implementations,
    and showcases recent measurements conducted on the LHC ion and proton
    beams.
\end{abstract}

\section{Introduction}
During its operation at flat top energy, the LHC ring stores up to \SI{350}{MJ} of beam energy, spread across 2808 bunches with an average beam transverse size under \SI{1}{mm}.
%
This high energy density can melt metallic surfaces and quench
superconducting magnets, posing a risk to the machine~\cite{LHC_report}.
%
To safely extract the beam from the circulating beam lines, a series of kicker magnets belonging to the beam dump system is used. 
%
Kicker magnets need \SI{3}{\micro\second} to ramp up their magnetic field~\cite{beam_dump_system}.
%
This defines the size of an Abort Gap (AG) in the bunch train.
%
Due to system imperfections, a residual amount of particles populates this gap.
%
The typical AG population levels are two to three orders of magnitude lower in comparison to a single pilot LHC bunch.
%
When the beam dump is initiated, the particles in the AG do not receive full
extraction force, are lost on their way to the dump line and can generate damages or magnet quenches.  
%
%That causes the particles in the AG to
%are deflects towards the vacuum chamber, possibly causing the magnets to quench. 
%
The purpose of the AGM \cite{particles_in_ag} is to 
a~continuous monitoring of the AG population in order to trigger the abort gap cleaning when  necessary. 
\\
This paper discusses the upgrade of the operational AGM installed in the LHC since 2010, detailing the system architecture and analog electronics chain, and provide a first performance comparison  of both systems.

\section{System architecture}
The system architecture is shown in Fig.~\ref{fig:bsra_chain}.
%
It depicts the layout of the LHC, with beam 1 represented in blue and beam 2 in red.
%
The LHC AGM consists of three main parts:
%
\begin{enumerate}
    \item \textbf{an optical front-end (OF)}, which includes~a pre-amplifier, located in the LHC tunnel,
    \item \textbf{a data acquisition system (DAQ)} deployed on an FPGA platform located outside the radiation area,
    \item \textbf{a control software (SW)} that retrieves, interprets, and publishes the measured data.
\end{enumerate}
%
\begin{figure}[!tbh]
    \centering
    \includegraphics[width=\columnwidth]{bsra_chain.pdf}
    \caption{Overview of an abort gap monitor system.}
    \label{fig:bsra_chain}
\end{figure} 

%
The AGM is installed at LHC IP4 as one of the beam diagnostics based on synchrotron radiation (SR) detection. %together with other beam diagnostic, and the LHC low-level RF system.
%
The LHC timing distribution (TTC) broadcasts through an optical cable - along the LHC - turn and bunch marks, together with other information, as e.g., actual beam energy~\cite{ttc_distribution}.
%
The bunch and turn marks identify the start of each individual bunch, and the position of the first bunch in a turn.   
%
The AGM uses this information to re-synchronize its acquisition window to the AG.
%
\subsection{Working principle}
%
An in-vacuum mirror intercepts  SR  emitted by protons passing through magnets located approximately 27 meters upstream. It then directs the radiation to a dedicated optical line installed beneath the beam pipe.

%The particle population in the AG is measured intercepting the synchrotron radiation (SR). 
%
The AGM is designed to collect part of th extracted SR on  a Multi-channel photo-multiplier (PMT), which converts it  into an electric signal.
%
Neutral Density filters in the optical front-end (OF) allow  changing the light intensity intercepted by the PMT, thus optimize the system dynamic range.
% 
Subsequently, the electric signal is amplified, and transmitted over a \SI{100}{m}-long cable to a Data Acquisition (DAQ) system.
%
The DAQ integrates the incoming signal in \SI{100}{\nano\second} intervals within a \SI{6.4}{\micro\second}-long acquisition window.
%
Each of the sixty-four \SI{100}{\nano\second} integrals is independently averaged in an Exponential Moving Averager (EMA).
%
The averaged result is published to the software with a repetition rate of 10~Hz, which is sufficient to react to even the fastest changes in AG population.~\cite{high_sensitivity_measurement}.
%
\\
The measurement period is determined by the PMT used.
%
In our case, it is HAMAMATSU R5916U-50. 
%
Its maximum duty cycle is \SI{1}{\%}. 
%
With a gate pulse duration of \SI{3}{\micro\second} and one LHC revolution period of \SI{89}{\micro\second}, the measurements are taken every $4^{\text{th}}$ clock cycle (\SI{356}{\micro\second}).
%
This corresponds to a duty cycle of \SI{0.84}{\%}.
\\
%

\subsection{Operational system, used since 2010}
\begin{figure}[!tbh]
    \centering
    \includegraphics[width=\columnwidth]{existing_system_processing.pdf}
    \caption{Operational AGM system overview}
    \label{fig:current_system_processing}
\end{figure}

The currently used system is shown in Fig.~\ref{fig:current_system_processing}.
%
The optical path, including filters, is common to both the operational version of the system, and the proposed upgrade. As well, the PMT type is the same in both systems.

The operational setup uses a digital acquisition board (DAB64x) equipped by Altera Stratix EP1S40 FPGA, used for the data processing.
%
The DAB64x hosts two Individual Bunch Measurement Systems (IBMS)~\cite{ibms}, integrating the analogue input signal via the LHCb2002 ASIC~\cite{lhcb_asic}.
%
The analogue signal is provided by MCP PMT, and it is amplified before the integration to improve on the measurement SNR.
%
The amplifier used is HAMAMATSU C5594~\cite{bsra_first_operation}, featuring a fixed voltage gain of \SI{36}{dBV}, in the bandwidth of \SI{50}{kHz} to \SI{1.5}{GHz}.
%
The LHCb2002 in the IBMS integrates the input amplified signal in \SI{25}{\nano\second} intervals, producing a stream of analogue 'DC-like' values.
%
These are subsequently sampled by a 40MSPS 14-bit ADC, resulting in a digital data stream, where each value corresponds to an integral of an individual LHC bunch.
%
The DAQ gateware sums four consecutive samples to compute the
bunch charge present on a~\SI{100}{ns} interval.
%
This process generates 64 values per single turn acquisition.
%
For each individual value, a standard deviation and mean value is calculated, and separately filtered by EMA. 
%
All collected data are stored in a RAM block shared to a front-end computer (FEC) via VME64 bridge.
%
The front-end acts as a server, publishing the data upstream through FESA~\cite{fesa}.

\subsection{Reasons for Upgrade}
The present AGM uses old technology to measure the beam charge. 
%
The analogue integrators used in IBMS are manufactured using obsoleted technology, rendering them impossible to get.
%
In addition, each integrator is unique: different gain, different switching characteristics, different offsets. 
%
So, the gateware must correct these effects.
%
Further, the amplifier bandwidth (50 kHz-1,5 GHz) increases system complexity, as a correction for the missing DC component needs to be implemented.
%
The amplifier gain is also fixed, so the ADC cannot optimally re-use available dynamic range.
\\
The system relies on an outdated FPGA platform, and the development SW is no more compatible with the latest operating systems. 

\section{System Upgrade}
To address the long-term maintenance concerns, the original system described above has to be refurbished. 
%
While the optics of the new system was copied from the operational one, the DAQ and the front-end amplifier were replaced by a modern solution.
%
A new DC-coupled amplifier was designed, allowing for dynamic change of the gain.
%
Original analogue integrators were replaced by a 4-channel 500MSPS 14-bit FMC-form factor sampler.
%
FMC ADC module is installed into an in-house built FPGA carrier (VFC-HD), featuring 2$\times 8$GBits DDR3 memories and a large Arria V FPGA.
%
Such solution eliminates completely the need for analogue integrators, as all the signal processing can be implemented in the gateware.  
\\
An updated version of the AGM was in 2023 installed \textit{in parallel to the actually running AGM}, so that we can compare behavior of both systems.

\subsection{New DC-coupled amplifier}

Figure \ref{fig:amp_schematics} depicts the block diagram of the new amplifier.
%
The amplifier was designed to match the used PMT, while being highly configurable.
% A = U^2/(i^2 * R^2) => A_dB = 20*log10(U/(i*R))
%
A~UART interface allows for setting a transimpedance gain.
%
The gain is selectable in a range of \SI{5.8}{mV/\micro A} to \SI{1.1}{V/\micro A}.
%
This corresponds to a~voltage gain of \SI{41}{dB} to \SI{87}{dB} in a $50\Omega$ system.
%
A programmatic DC-offset compensation is implemented in the amplifier.
%
It can be used - together with variable gain - to optimize the signal's amplitude for the ADC.
%
The amplifier implements an alarm, which interlocks the PMT gate when the incident light generates a current, that is near the PMT's maximum allowable average current.
%
The alarm threshold setting is stored through UART into the amplifier's non-volatile memory, so that it protects the PMT immediately at the amplifier power-up.
%
The alarm status is also transmitted to the gateware.
%
\begin{figure}[!tbh]
    \centering
    \includegraphics[width=\columnwidth]{amp_schematics.pdf}
    \caption{New AGM custom amplifier.}
    \label{fig:amp_schematics}
\end{figure}
%
\subsection{Acquisition system}
\begin{figure}[!tbh]
    \centering
    \includegraphics[width=\columnwidth]{bsra_daq.pdf}
    \caption{Acquisition system schematics.}
    \label{fig:bsra_daq}
\end{figure}
%
The new DAQ (Fig.~\ref{fig:bsra_daq}) receives asynchronous data samples as a stream of four frames every~\SI{8}{\nano s}, each corresponding to one channel.
%
Each frame contains 4$\times$16-bit words, storing left-aligned 14-bit ADC samples. 
%
To compute integrals over 4$\times$~\SI{25}{\nano\second} bunch slots, the system employs data tagging. 
%
The tagger resamples LHC timing, and generates timing masks, allowing for identification of bunch and turn starts within each individual ADC frame.
%
Tags are written into 2 unused LSBs of each word to indicate the position of the start of the bunch or turn.
\\
%
The tagged samples are stored into a~FIFO, and integrated. 
%
The integrator begins summing values upon encountering the first bunch tag appearing within the acquisition window.
%
In parallel, it reads a stream of 64~values of a stored 'offset' from a pedestal memory (P[63:0]).
%
The offset is on-fly subtracted from the integrated data stream. 
%
Such pedestal subtraction is needed to remove systematic effects, e.g., PMT gate opening. 
%
The output values are filtered by an EMA, results are kept in RAM, and read out through the VME64x bus~\cite{my_thesis}.

\begin{figure}[!tbh]
    \centering
    \includegraphics[width=1.0\columnwidth]{installation.jpg}
    \caption{New AGM installed in the LHC IP4, next to BSRT.}
    \label{fig:installation}
\end{figure}

\subsection{Installation in the LHC}

The new installation is depicted \textit{in retracted position} in Fig.~\ref{fig:installation}, highlighted by a~violet frame.
%
Adjacent to its right is the operational AGM, while the longitudinal density monitor (LDM) occupies the left side.
%
All instruments share the same light source provided by the LHC beam synchronous light telescope (BSRT).
%
The red arrow indicates the direction of the light entering the optical table.
%
The light is unequally split using multiple reflective foils into their respective destinations such, that the new AGM intercepts only 10\% of luminosity of the operational AGM.
%
Both AGMs are equipped with LEDs installed atop of their reflective foils.
%
These serve to perform functional tests.
%
The new AGM amplifier is mounted on the top of the optical front-end to ease the interventions.

\section{First measurements}

\vspace{-5mm}
\begin{figure}[!htb]
    \begin{center}
        \scalebox{0.54}{\input{plots/ions.pgf}}
        \caption{Comparison of the AGM measurements}
        \label{fig:comparison_chart}
    \end{center}
\end{figure}

\vspace{-5mm}
The initial measurements were conducted in November 2023 using the LHC ion beam.
%
Figure~\ref{fig:comparison_chart} shows the very first measurements, compared to the operational AGM.
%
Both measurements agree to 2\% within the operational area, signals however deviate starting at $47^{\text{th}}$ bin, resulting in maximum relative error of 4\%.
%
This is surprising, as no signal shall be present - the PMT gates are closed. 
%
However, the operational AGM signal gradually decays, and extends below zero.
%
This effect is systematic, and is mostly caused by analogue signal processing chain and non-ideal analogue integration.
%
The new system effectively eliminates this.


\section{Summary}
The presented text describes upgrade of the operational abort gap monitor. 
%
The operational system has to be replaced in the near future by a new AGM to assure long-term maintainability.
%
A fully digital solution was developed.
%
To assess its performance, it was installed in the LHC, on beam 1, in parallel with the operational AGM.
%
Very first measurements from November 2023 show exceptionally good performance even using considerably lower amount of intercepted light.
%
The upgraded AGM is now collecting data from the LHC 2024 proton run.
%
Further analysis in terms of accuracy, reliability, and stability has to be conducted, with the ultimate goal of replacing both operational AGMs by their new versions.

\input{bibliography}

\end{document}

